---
title: "R Notebook"
output: html_notebook
---

In this document I describe the analysis that was requested by Andy Dunstan on a conference call on Sept 24, 2020. The purpose of this analysis is to (1) identify the number of inundations each nest experienced, (2) determine the duration of these inundation events, (3) determine the phase of incubation at these inundation events, and (4) determine the maximum tidal height and total duration at that maximum height of each inundation event. These bullet items were provided in the email from Owen Coffee on Oct 2, 2020. Nine files were attached to the email. The hatch success data were in hatchsuccess_inund_2020-10-02.csv, whereas raw data from tidal height data loggers were in Loggerx_y.csv files, where x and y specified individual loggers. 


```{r}
# clear the workspace and bring in libraries
rm(list=ls())
library(ggplot2)
library(tidyverse)
library(readr)
library(lubridate)

source("Dunstan_Inundation_fcns.R")
save.fig <- T
```

Bring in all data files and take a look at them.

```{r}
# The last five fields (Number_inundation_events to Duration_max_inundation) are empty.
# I changed "%_success" to "prop_success".

inund.cols <- cols(fid = col_integer(),
                   Nest_UID = col_character(),
                   Northings = col_double(),
                   Eastings = col_double(),
                   Nest_Elevation = col_double(),
                   Berm_Dist = col_double(),
                   Habitat = col_character(),
                   Sector = col_character(),
                   Island_Aspect = col_character(),
                   ID_closest_logger = col_character(),
                   Season = col_character(),
                   Survey = col_character(),
                   Incubation_Start = col_date(format = "%d/%m/%Y"),
                   Incubation_Finish = col_date(format = "%d/%m/%Y"),
                   Date_dug = col_date(format = "%d/%m/%Y"),
                   Hatched = col_integer(),
                   Live_hatchlings = col_integer(),
                   Dead_hatchlings = col_integer(),
                   Phase_1 = col_integer(),
                   Phase_2 = col_integer(),
                   Phase_3 = col_integer(),
                   Phase_4 = col_integer(),
                   Phase_5 = col_integer(),
                   Phase_6 = col_integer(),
                   Decomposed = col_integer(),
                   Total_unhatched = col_integer(),
                   Total_clutch = col_integer(),
                   prop_success = col_double(),
                   Number_inundation_events = col_integer(),
                   Inundation_period_per_event = col_integer(),
                   Phase_incubation_per_inundation = col_integer(),
                   Max_inundation_height_event = col_double(),
                   Duration_max_inundation = col_double())

# I changed column headings 
logger.cols <- cols(Logger_Depth = col_double(),
                    Date_Time = col_datetime(format = "%d/%m/%Y %H:%M"),
                    Height_LAT = col_double())

inund <- read_csv("data/hatchsuccess_inund_2020-10-02_TE.csv", 
                  col_types = inund.cols)

logger.3.2 <- read_csv("data/Logger3_2.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "3.2",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.4.1 <- read_csv("data/Logger4_1.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "4.1",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.4.2 <- read_csv("data/Logger4_2.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "4.2",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.4.3 <- read_csv("data/Logger4_3.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "4.3",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.4.4 <- read_csv("data/Logger4_4.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "4.4",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.5.1 <- read_csv("data/Logger5_1.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "5.1",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.5.2 <- read_csv("data/Logger5_2.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "5.2",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
logger.5.4 <- read_csv("data/Logger5_4.csv",
                       col_types = logger.cols) %>%
  mutate(Logger_ID = "5.4",
         Logger_Depth = min(Logger_Depth, na.rm = TRUE),
         Date = as.Date(Date_Time, format = "%Y-%m-%d"))
loggers <- rbind(logger.3.2, logger.4.1, logger.4.2, logger.4.3,
                logger.4.4, logger.5.1, logger.5.2, logger.5.4)
```

Look at the data:

```{r}
p.tide <- ggplot(data = loggers) + 
  geom_path(aes(x = Date_Time, y = Height_LAT),
            alpha = 0.5) + 
  facet_wrap(~ as.factor(Logger_ID))

#p.tide
```

For each nest (row) in inund, data from one logger are assigned (ID_closest_logger). The tide height relative to the nest height is examined.

```{r}

k <-  c <- 1
inundated.nests <- vector(mode = "list")
for (k in 1:nrow(inund)){
  # in tibble, a variable needs to be pulled to get out of the tibble format
  # 'pull' does that trick.
  inund.k <- inund[k,]
  logger.id <- pull(inund.k, "ID_closest_logger")
  date.begin <- pull(inund.k, "Incubation_Start")
  date.end <- pull(inund.k, "Incubation_Finish")
  nest.depth <- pull(inund.k, "Nest_Elevation")   # this is key... 
  
  loggers %>% 
    filter(str_detect(Logger_ID, as.character(logger.id))) %>%
    filter(Date >= date.begin & 
             Date <= date.end) -> logger.k
  
  inund.nest <- filter(logger.k, Height_LAT > nest.depth)
  
  if (nrow(inund.nest) > 0){
    #print(paste0("inundation at nest ", k))
    inundated.nests[[c]] <- list(logger.data = logger.k,
                                 nest.depth = nest.depth,
                                 logger.ID = logger.id,
                                 nest.ID = inund.k$Nest_UID,
                                 date.begin = date.begin,
                                 date.end = date.end)
    
    # p.inund <- ggplot() +
    #   geom_path(data = logger.k,
    #             aes(x = Date_Time, y = Height_LAT)) +
    #   geom_hline(data = inund.k,
    #              aes(yintercept = Nest_Elevation)) +
    #   ggtitle(paste0("Nest_UID = ", inund.k$Nest_UID))
    # 
    # if (save.fig) ggsave(filename = paste0("figures/inundation_nest_", inund.k$Nest_UID, ".png"),
    #                      device = "png", dpi = 600)
    # 
    c <- c + 1
  }            
}

```

According to the plots, it was almost all-or-nothing. I asked Andy and Owen if I was using the right numbers, i.e., Height_LAT and Nest_Elevation. I have the feeling there has to be some sort of additions/subtractions need to happen? I'll wait for them to respond. It turned out, it was my error. I did not use "pull" to extract the nest elevation, which resulted in erroneous comparison with the Height_LAT. 

Moving on with inundated nests... figuring out how many times each nest was inundated, how long each inundation event was, phase of incubation of each inundation event, maximum water height per inundation event, the duration of the highest inundation event.


```{r}
# for each reading of logger, determine whether or not the nest height was greater (not inundated) than the water height (Height_LAT).
k1 <- 1
for (k1 in 1:length(inundated.nests)){
  logger.k <- inundated.nests[[k1]]$logger.data
  nest.depth <- inundated.nests[[k1]]$nest.depth
  nest.ID <-  inundated.nests[[k1]]$nest.ID
  logger.ID <- inundated.nests[[k1]]$logger.ID
  date.begin <- inundated.nests[[k1]]$date.begin
  date.end <- inundated.nests[[k1]]$date.end
    
  total.days <- as.numeric(date.end - date.begin)
  logger.k %>% mutate(inund = ifelse(Height_LAT >= nest.depth, 1, 0)) -> logger.k
  # extract the inundation recordings
  logger.k %>% filter(inund == 1) -> logger.k.inund 
    
  # if the nest was entirely underwater, no need to figure out how many times it was inundated
  if (sum(logger.k$inund) == nrow(logger.k)){
    n.inund <- 1
    logger.k.inund$inund.ID <- 1
    time.inund <- logger.k$Date_Time[nrow(logger.k)] - logger.k$Date_Time[1]
    time.inund.unit <- units(logger.k$Date_Time[nrow(logger.k)] - logger.k$Date_Time[1])
    max.height <- max(logger.k$Height_LAT)
    inund.time <- NA
    inund.time.unit <- NA
    inund.phase <- NA
    inund.phase.unit <- NA
    days.max.inund <- NA
    
  } else {  # if there were at least one un-inundated reading, we need to figure out inundation events
    
    if (nrow(logger.k.inund) > 1){
      # compute the time differences - look for those > 15 min
      logger.k.inund$delta.time <- c(15, as.numeric(unlist(logger.k.inund[2:nrow(logger.k.inund), "Date_Time"] - logger.k.inund[1:(nrow(logger.k.inund) -1), "Date_Time"])))
      
      # identify inundation periods
      tmp <- vector(mode = "numeric", length = nrow(logger.k.inund))
      tmp[logger.k.inund$delta.time > 15] <- 1
      tmp <- cumsum(tmp) + 1
      logger.k.inund$inund.ID <- tmp
      n.inund <- max(tmp)
      
      # compute the inundation statistics for each inundation event
      time.inund <- vector(mode = "numeric", length = n.inund)
      time.inund.unit <- vector(mode = "character", length = n.inund)

      # Rather than "phase" I use # days from start date
      inund.time <- vector(mode = "numeric", length = n.inund)
      inund.time.unit <- vector(mode = "character", length = n.inund)
      
      max.height <- vector(mode = "numeric", length = n.inund)

      k3 <- 1
      
      for (k3 in 1:n.inund){
        inund.tmp <- filter(logger.k.inund, inund.ID == k3)
        time.inund[k3] <- inund.tmp$Date_Time[nrow(inund.tmp)] - inund.tmp$Date_Time[1]
        time.inund.unit[k3] <- units(inund.tmp$Date_Time[nrow(inund.tmp)] - inund.tmp$Date_Time[1])
        inund.time[k3] <- inund.tmp$Date_Time[nrow(inund.tmp)] - logger.k$Date_Time[1]
        inund.time.unit[k3] <- units(inund.tmp$Date_Time[nrow(inund.tmp)] - logger.k$Date_Time[1])
        max.height[k3] <- max(inund.tmp$Height_LAT)
      }
      
      days.max.inund <- NA
      
    } else {
      max.height <- logger.k.inund$Height_LAT
      n.inund <- 1
      logger.k.inund$inund.ID <- 1
      time.inund <- 29
      time.inund.unit <- "minute"
      inund.time <- logger.k.inund$Date_Time - logger.k$Date_Time[1]
      inund.time.unit <- units(logger.k.inund$Date_Time - logger.k$Date_Time[1])
      days.max.inund <- NA
      
    }
    
  }
  
  inundated.nests[[k1]] <- list(nest.ID = nest.ID,
                                logger.ID = logger.ID,
                                date.begin = date.begin,
                                date.end = date.end, 
                                logger.data = logger.k,
                                logger.inund.data = logger.k.inund,
                                nest.depth = nest.depth,
                                max.height = max.height,
                                n.inund = n.inund,
                                time.inund = time.inund,
                                time.inund.unit = time.inund.unit,
                                inund.phase = inund.phase,
                                inund.phase.unit = inund.phase.unit,
                                days.max.inund = days.max.inund)
}
```


Let's make some plots to see how they look.

```{r}
k <- 2
for (k in 1:length(inundated.nests)){
  
  p.inund <- ggplot() +
    geom_path(data = inundated.nests[[k]]$logger.data,
              aes(x = Date_Time, y = Height_LAT)) +
    geom_path(data = inundated.nests[[k]]$logger.inund.data,
              aes(x = Date_Time, y = Height_LAT, color = as.factor(inund.ID))) +
    geom_hline(data = data.frame(nest.depth = inundated.nests[[k]]$nest.depth),
               aes(yintercept = nest.depth)) +
    ggtitle(paste0("Nest_UID = ", inundated.nests[[k]]$nest.ID, 
                   ", Logger = ", inundated.nests[[k]]$logger.ID)) + 
    theme(legend.position = "none")
  
    if (save.fig) ggsave(filename = paste0("figures/inundation_nest_", 
                                           inundated.nests[[k]]$nest.ID, ".png"),
                         device = "png", dpi = 600)
}




```

